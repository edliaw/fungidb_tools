#!/usr/bin/env python

from __future__ import print_function
import os
import argparse
from lxml import etree
from fungidb_tools.xml import datasets
from fungidb_tools.xml.ElementLib import indent
import json

DEFAULT_JSON = os.path.expanduser("~/workspace/FungiDB.json")
DEFAULT_DATASETS = os.path.expanduser("~/workspace/FungiDB.xml")


def parse_arguments():
    """Handle command-line arguments.

    Returns:
        args: Arguments passed in from the command-line.
    """
    parser = argparse.ArgumentParser(description=__doc__,
                                     fromfile_prefix_chars='@')
    parser.add_argument('infile',
                        type=argparse.FileType('r'), nargs='?',
                        default=open(DEFAULT_JSON),
                        help='input .json spreadsheet rows')
    parser.add_argument('outfile',
                        type=argparse.FileType('w'), nargs='?',
                        default=open(DEFAULT_DATASETS, 'w'),
                        help='output .xml filename')
    parser.add_argument('-c', '--check',
                        action='store_true',
                        help='check spreadsheet for errors')
    return parser.parse_args()


def main():
    args = parse_arguments()

    with args.infile as infile:
        organisms = json.load(infile)

    datasets_xml = datasets.make_datasets_xml(organisms, args.check)
    indent(datasets_xml)

    with args.outfile as outfile:
        print(etree.tostring(datasets_xml), file=outfile)


if __name__ == "__main__":
    main()
